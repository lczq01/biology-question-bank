# 架构设计文档

<!-- 状态同步区块 -->
**引用自**: 00-项目总览.md#核心架构决策  
**上次同步**: 2025-10-08  
**关键依赖**: 分层状态管理方案、双系统架构设计
<!-- 结束状态同步区块 -->

## 文档摘要

**核心架构**: 单一考试系统架构（通过参数化支持练习功能）  
**技术栈**: React + Material-UI前端，Express.js + TypeScript后端  
**设计模式**: 分层状态管理、模块化组件设计  
**当前状态**: 架构重构完成，系统稳定运行

## 系统总体架构

### 1.1 单一系统架构设计

```
生物题库管理系统
└── 考试系统 (单一架构)
    ├── 考试管理 (Exam Management)
    │   ├── 考试创建
    │   ├── 考试发布
    │   ├── 考试监控
    │   ├── 手动组卷
    │   └── 自动组卷
    └── 考试参与
        ├── 正式考试模式
        └── 练习模式（通过URL参数区分）
```

**架构变更说明**:
- **原架构**: 双系统分离（考试系统 + 练习系统）
- **新架构**: 单一考试系统架构
- **变更原因**: 通过参数化考试系统实现练习功能，避免重复建设
- **实施状态**: 练习系统已删除，代码清理完成

### 1.2 权限控制架构

**角色权限划分**:
- **管理员**: 完整系统权限，管理考试系统
- **学生**: 参与考试和练习权限

**概念澄清**:
- **考试管理 (Exam Management)**: 管理员功能，创建和管理正式考试活动，包含手动/自动组卷
- **练习功能**: 通过考试系统的参数化配置实现，学生可参与练习模式

**功能权限矩阵**:
| 功能模块 | 管理员权限 | 学生权限 |
|---------|-----------|---------|
| 试卷管理 | ✅ 完整权限 | ❌ 无权限 |
| 考试管理 | ✅ 完整权限 | ❌ 无权限 |
| 考试参与 | ✅ 完整权限 | ✅ 参与权限 |
| 练习模式 | ✅ 配置权限 | ✅ 参与权限 |
| 自动组卷 | ✅ 完整权限 | ❌ 无权限 |
| 手动组卷 | ✅ 完整权限 | ❌ 无权限 |

**架构优势**:
- ✅ 避免功能重复建设
- ✅ 简化系统维护复杂度
- ✅ 统一用户体验
- ✅ 减少代码冗余

## 技术架构设计

### 2.1 前端架构

**技术栈选择**:
- **框架**: React 18 + TypeScript
- **UI组件**: Material-UI v6
- **状态管理**: React Context + useReducer
- **路由**: React Router v6
- **构建工具**: Vite 5

**组件架构原则**:
- 单一职责原则：每个组件专注一个功能
- 组合优于继承：通过组件组合实现复杂功能
- 状态提升：共享状态提升到合适层级

### 2.2 后端架构

**技术栈选择**:
- **运行时**: Node.js + Express.js
- **语言**: TypeScript
- **数据库**: MongoDB + Mongoose
- **认证**: JWT + 自定义中间件

**API设计原则**:
- RESTful风格接口设计
- 统一的错误处理机制
- 数据验证和安全性保障

## 数据模型设计

### 3.1 核心数据模型

**试卷相关模型 (Paper Management)**:
```typescript
// 试卷模型 - 试卷模板，包含题目组合和配置
interface ExamPaper {
  id: string;
  title: string;
  description?: string;
  questions: Array<{
    questionId: string;
    order: number;
    points: number;
  }>;
  totalQuestions: number;
  totalPoints: number;
  config: {
    allowReview: boolean;
    shuffleQuestions: boolean;
    shuffleOptions: boolean;
    showAnswers: boolean;
  };
  createdAt: string;
  updatedAt: string;
  createdBy: string;
}
```

**考试相关模型 (Exam Management)**:
```typescript
// 考试会话模型 - 基于试卷创建的具体考试活动
interface ExamSession {
  id: string;
  name: string;
  description?: string;
  paperId: string; // 关联试卷模板
  status: 'draft' | 'published' | 'archived'; // 管理状态
  openTime: Date;    // 考试开放时间 - 学生可以开始参加考试的时间
  closeTime: Date;   // 考试关闭时间 - 学生不能再开始新考试的时间
  duration: number; // 考试时长（分钟）
  allowRetake: boolean; // 是否允许重考（替代原来的maxAttempts）
  passingScore: number;
  settings: {
    allowReview: boolean;
    shuffleQuestions: boolean;
    showResults: boolean;
  };
  stats: {
    totalAttempts: number;
    averageScore: number;
    passRate: number;
  };
  createdAt: string;
  updatedAt: string;
  createdBy: string;
}

// 考试记录模型
interface ExamRecord {
  id: string;
  sessionId: string;
  userId: string;
  status: 'not_started' | 'in_progress' | 'completed';
  score?: number;
  startTime?: Date;
  endTime?: Date;
}
```

**练习功能实现**:
```typescript
// 通过考试系统参数化实现练习功能
interface ExamSession {
  id: string;
  name: string;
  description?: string;
  paperId: string;
  mode: 'exam' | 'practice'; // 新增：区分考试模式和练习模式
  status: 'draft' | 'published' | 'archived';
  openTime: Date;
  closeTime: Date;
  duration: number;
  allowRetake: boolean;
  passingScore: number;
  settings: {
    allowReview: boolean;
    shuffleQuestions: boolean;
    showResults: boolean;
  };
  stats: {
    totalAttempts: number;
    averageScore: number;
    passRate: number;
  };
  createdAt: string;
  updatedAt: string;
  createdBy: string;
}
```

**练习模式配置**:
- 练习模式允许无限次重考
- 练习模式显示正确答案
- 练习模式不记录正式成绩
- 练习模式可随时暂停和继续

**试卷类型区分方案**:
```typescript
// 试卷用途类型枚举 - 区分练习卷和考试卷
export enum PaperUsageType {
  PRACTICE = 'practice',    // 练习卷
  EXAM = 'exam'            // 考试卷
}

// 扩展试卷模型，添加paperType字段
interface EnhancedPaper {
  id: string;
  title: string;
  description?: string;
  type: PaperType;         // 原有的试卷类型（manual/auto）
  paperType: PaperUsageType; // 新增：试卷用途类型（练习卷或考试卷）
  sourceContext?: {        // 新增：来源上下文信息
    system: 'practice' | 'exam';
    page: string;
    userId: string;
    timestamp: Date;
  };
  // 其他字段保持不变...
}
```

### 3.2 分层状态管理设计

**状态分层架构**:
```typescript
// 状态计算函数
const getExamStatus = (examSession: ExamSession) => {
  const now = new Date();
  
  return {
    // 管理状态（管理员可见）
    adminStatus: examSession.status,
    
    // 时间状态（自动计算）
    timeStatus: now < examSession.openTime ? 'not_started' : 
               now <= examSession.closeTime ? 'in_progress' : 'ended',
    
    // 学生可见状态
    studentVisible: examSession.status === 'published' && 
                   (now >= examSession.openTime && now <= examSession.closeTime)
  };
};
```

## 核心设计模式

### 4.1 状态管理模式

**设计目标**:
- 解决考试状态混乱问题
- 实现管理端和学生端的状态视图分离
- 支持自动化状态转换
- 区分练习卷和考试卷的用途类型

**实现方案**:
- 计算属性模式：实时计算时间相关状态
- 状态机模式：明确状态转换规则
- 观察者模式：状态变化时通知相关组件
- 类型标记模式：通过paperType字段区分试卷用途

### 4.2 权限控制模式

**设计原则**:
- 基于角色的访问控制（RBAC）
- 资源级别的权限验证
- 前端路由守卫 + 后端API验证
- 试卷类型关联权限：根据paperType设置不同的权限规则

**模式权限控制**:
```typescript
// 根据考试模式设置权限规则
const getExamPermissions = (exam: ExamSession, user: IUser) => {
  const basePermissions = {
    canEdit: user.role === 'admin' || exam.createdBy === user.id,
    canDelete: user.role === 'admin',
    canPublish: user.role === 'admin'
  };
  
  // 练习模式：学生可以参与练习
  if (exam.mode === 'practice') {
    return {
      ...basePermissions,
      canCreate: user.role === 'admin', // 只有管理员可以创建练习活动
      canView: true,     // 学生可以查看练习活动
      canTake: true      // 学生可以参与练习
    };
  }
  
  // 考试模式：正式考试权限控制
  if (exam.mode === 'exam') {
    return {
      ...basePermissions,
      canCreate: user.role === 'admin',
      canView: user.role === 'admin',
      canTake: exam.participants.includes(user.id) || exam.participants.length === 0
    };
  }
};
```

### 4.3 错误处理模式

**统一错误处理**:
- 前端：全局错误边界组件
- 后端：统一错误中间件
- 日志：结构化错误记录

## 系统集成设计

### 5.1 前后端数据流

**API通信规范**:
- 请求/响应数据格式标准化
- 错误代码统一管理
- 加载状态和错误状态处理

**数据同步策略**:
- 实时数据：WebSocket或轮询
- 静态数据：缓存策略
- 用户数据：本地存储 + 服务端同步

### 5.2 第三方集成

**现有集成**:
- MongoDB数据库
- JWT认证系统
- 文件上传系统

**计划集成**:
- 闪卡复习系统
- 学习任务推送
- 数据分析仪表板

## 性能优化设计

### 6.1 前端性能优化

**加载优化**:
- 代码分割和懒加载
- 图片和资源优化
- 缓存策略实施

**运行时优化**:
- 组件记忆化（React.memo, useMemo）
- 虚拟滚动列表
- 防抖和节流处理

### 6.2 后端性能优化

**数据库优化**:
- 索引优化
- 查询性能监控
- 连接池管理

**API优化**:
- 响应压缩
- 请求批处理
- 缓存策略

## 安全设计

### 7.1 数据安全

**加密策略**:
- 敏感数据加密存储
- 传输层加密（HTTPS）
- JWT令牌安全

**访问控制**:
- API权限验证
- 数据访问权限控制
- 操作日志记录

### 7.2 应用安全

**输入验证**:
- 前端表单验证
- 后端数据验证
- SQL注入防护

**会话安全**:
- 安全的Cookie设置
- 会话超时管理
- 跨站请求伪造防护

## 扩展性设计

### 8.1 模块化扩展

**插件架构**:
- 功能模块独立开发
- 标准接口定义
- 热插拔支持

**配置化设计**:
- 功能开关配置
- 主题样式配置
- 业务规则配置

### 8.2 技术债务管理

**代码质量**:
- 代码审查流程
- 自动化测试覆盖
- 技术债务追踪

**重构策略**:
- 渐进式重构
- 向后兼容保证
- 风险控制机制

## 部署架构

### 9.1 环境配置

**多环境支持**:
- 开发环境
- 测试环境
- 生产环境

**配置管理**:
- 环境变量配置
- 密钥安全管理
- 部署脚本自动化

### 9.2 监控运维

**日志系统**:
- 结构化日志记录
- 日志聚合分析
- 错误追踪集成

**性能监控**:
- 应用性能监控
- 用户体验监控
- 业务指标监控

## 版本记录

### v1.0.0 (2025-10-08)
**初始版本**: 架构设计文档创建
**主要内容**:
- 双系统架构设计
- 分层状态管理方案
- 技术栈选择和设计原则

---

**最后更新**: 2025-10-08  
**维护人员**: 架构设计团队  
**下一计划更新**: 架构重大变更时