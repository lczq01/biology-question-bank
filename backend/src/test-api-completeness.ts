import axios from 'axios';
import { connectDatabase } from './utils/database';
import { config } from './utils/config';

const API_BASE_URL = 'http://localhost:3001/api';
const MOCK_TOKEN = 'mock_token_67890abcdef12345';

/**
 * åç«¯APIå®Œæ•´æ€§æµ‹è¯•
 * éªŒè¯æ‰€æœ‰æ ¸å¿ƒAPIç«¯ç‚¹çš„åŠŸèƒ½å’Œå“åº”
 */
class APICompletenessTest {
  private testResults: { [key: string]: boolean } = {};
  private testDetails: { [key: string]: any } = {};

  constructor() {
    // è®¾ç½®é»˜è®¤è¯·æ±‚å¤´
    axios.defaults.headers.common['Authorization'] = `Bearer ${MOCK_TOKEN}`;
    axios.defaults.headers.common['Content-Type'] = 'application/json';
  }

  /**
   * è®°å½•æµ‹è¯•ç»“æœ
   */
  private recordTest(testName: string, success: boolean, details?: any) {
    this.testResults[testName] = success;
    this.testDetails[testName] = details;
    console.log(`${success ? 'âœ…' : 'âŒ'} ${testName}`);
    if (details && !success) {
      console.log(`   è¯¦æƒ…: ${JSON.stringify(details, null, 2)}`);
    }
  }

  /**
   * æµ‹è¯•ç”¨æˆ·è®¤è¯API
   */
  async testAuthAPI() {
    console.log('\n1ï¸âƒ£ æµ‹è¯•ç”¨æˆ·è®¤è¯API...');
    
    try {
      // æµ‹è¯•ç™»å½•
      const loginResponse = await axios.post(`${API_BASE_URL}/auth/login`, {
        username: 'admin',
        password: 'admin123'
      });
      this.recordTest('ç”¨æˆ·ç™»å½•API', loginResponse.status === 200, loginResponse.data);

      // æµ‹è¯•ç”¨æˆ·ä¿¡æ¯è·å–
      const userInfoResponse = await axios.get(`${API_BASE_URL}/auth/me`);
      this.recordTest('ç”¨æˆ·ä¿¡æ¯è·å–API', userInfoResponse.status === 200, userInfoResponse.data);

    } catch (error: any) {
      this.recordTest('ç”¨æˆ·è®¤è¯API', false, error.response?.data || error.message);
    }
  }

  /**
   * æµ‹è¯•é¢˜ç›®ç®¡ç†API
   */
  async testQuestionAPI() {
    console.log('\n2ï¸âƒ£ æµ‹è¯•é¢˜ç›®ç®¡ç†API...');
    
    try {
      // æµ‹è¯•é¢˜ç›®åˆ—è¡¨æŸ¥è¯¢
      const questionsResponse = await axios.get(`${API_BASE_URL}/questions`, {
        params: { page: 1, limit: 10 }
      });
      this.recordTest('é¢˜ç›®åˆ—è¡¨æŸ¥è¯¢API', questionsResponse.status === 200, {
        count: questionsResponse.data.data?.length || 0,
        total: questionsResponse.data.total
      });

      // æµ‹è¯•é¢˜ç›®ç­›é€‰
      const filterResponse = await axios.get(`${API_BASE_URL}/questions/filter`, {
        params: { 
          subject: 'ç”Ÿç‰©',
          difficulty: 'easy',
          page: 1,
          limit: 5
        }
      });
      this.recordTest('é¢˜ç›®ç­›é€‰API', filterResponse.status === 200, {
        count: filterResponse.data.data?.length || 0
      });

      // æµ‹è¯•é¢˜ç›®åˆ›å»º
      const createQuestionData = {
        title: 'APIæµ‹è¯•é¢˜ç›®',
        content: 'è¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•é¢˜ç›®',
        type: 'single_choice',
        difficulty: 'easy',
        subject: 'ç”Ÿç‰©',
        chapter: 'APIæµ‹è¯•ç« èŠ‚',
        keywords: ['æµ‹è¯•'],
        options: [
          { id: 'A', text: 'é€‰é¡¹A', isCorrect: true },
          { id: 'B', text: 'é€‰é¡¹B', isCorrect: false }
        ],
        correctAnswer: 'A',
        points: 5
      };

      const createResponse = await axios.post(`${API_BASE_URL}/questions`, createQuestionData);
      this.recordTest('é¢˜ç›®åˆ›å»ºAPI', createResponse.status === 201, createResponse.data);

      if (createResponse.status === 201 && createResponse.data.data?._id) {
        const questionId = createResponse.data.data._id;

        // æµ‹è¯•é¢˜ç›®è¯¦æƒ…æŸ¥è¯¢
        const detailResponse = await axios.get(`${API_BASE_URL}/questions/${questionId}`);
        this.recordTest('é¢˜ç›®è¯¦æƒ…æŸ¥è¯¢API', detailResponse.status === 200, detailResponse.data);

        // æµ‹è¯•é¢˜ç›®æ›´æ–°
        const updateData = { ...createQuestionData, title: 'APIæµ‹è¯•é¢˜ç›®(å·²æ›´æ–°)' };
        const updateResponse = await axios.put(`${API_BASE_URL}/questions/${questionId}`, updateData);
        this.recordTest('é¢˜ç›®æ›´æ–°API', updateResponse.status === 200, updateResponse.data);

        // æµ‹è¯•é¢˜ç›®åˆ é™¤
        const deleteResponse = await axios.delete(`${API_BASE_URL}/questions/${questionId}`);
        this.recordTest('é¢˜ç›®åˆ é™¤API', deleteResponse.status === 200, deleteResponse.data);
      }

    } catch (error: any) {
      this.recordTest('é¢˜ç›®ç®¡ç†API', false, error.response?.data || error.message);
    }
  }

  /**
   * æµ‹è¯•è¯•å·ç®¡ç†API
   */
  async testPaperAPI() {
    console.log('\n3ï¸âƒ£ æµ‹è¯•è¯•å·ç®¡ç†API...');
    
    try {
      // æµ‹è¯•è¯•å·åˆ—è¡¨æŸ¥è¯¢
      const papersResponse = await axios.get(`${API_BASE_URL}/exam-papers`);
      this.recordTest('è¯•å·åˆ—è¡¨æŸ¥è¯¢API', papersResponse.status === 200, {
        count: papersResponse.data.data?.length || 0
      });

      // æµ‹è¯•è‡ªåŠ¨ç»„å·
      const autoGenerateData = {
        title: 'APIæµ‹è¯•è‡ªåŠ¨ç»„å·',
        description: 'è¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•è‡ªåŠ¨ç»„å·',
        config: {
          totalQuestions: 5,
          totalPoints: 25,
          timeLimit: 60,
          allowReview: true,
          shuffleQuestions: false,
          shuffleOptions: false
        },
        autoPaperConfig: {
          totalQuestions: 5,
          totalPoints: 25,
          typeDistribution: {
            single_choice: { count: 3, points: 15 },
            multiple_choice: { count: 2, points: 10 }
          },
          difficultyDistribution: {
            easy: 60,
            medium: 30,
            hard: 10
          }
        }
      };

      const autoGenerateResponse = await axios.post(`${API_BASE_URL}/exam-papers/auto-generate`, autoGenerateData);
      this.recordTest('è‡ªåŠ¨ç»„å·API', autoGenerateResponse.status === 201, autoGenerateResponse.data);

      if (autoGenerateResponse.status === 201 && autoGenerateResponse.data.data?._id) {
        const paperId = autoGenerateResponse.data.data._id;

        // æµ‹è¯•è¯•å·è¯¦æƒ…æŸ¥è¯¢
        const paperDetailResponse = await axios.get(`${API_BASE_URL}/exam-papers/${paperId}`);
        this.recordTest('è¯•å·è¯¦æƒ…æŸ¥è¯¢API', paperDetailResponse.status === 200, paperDetailResponse.data);

        // æµ‹è¯•è¯•å·åˆ é™¤
        const deletePaperResponse = await axios.delete(`${API_BASE_URL}/exam-papers/${paperId}`);
        this.recordTest('è¯•å·åˆ é™¤API', deletePaperResponse.status === 200, deletePaperResponse.data);
      }

    } catch (error: any) {
      this.recordTest('è¯•å·ç®¡ç†API', false, error.response?.data || error.message);
    }
  }

  /**
   * æµ‹è¯•è€ƒè¯•ä¼šè¯ç®¡ç†API
   */
  async testExamSessionAPI() {
    console.log('\n4ï¸âƒ£ æµ‹è¯•è€ƒè¯•ä¼šè¯ç®¡ç†API...');
    
    try {
      // æµ‹è¯•è€ƒè¯•ä¼šè¯åˆ—è¡¨æŸ¥è¯¢
      const sessionsResponse = await axios.get(`${API_BASE_URL}/exam-sessions`);
      this.recordTest('è€ƒè¯•ä¼šè¯åˆ—è¡¨æŸ¥è¯¢API', sessionsResponse.status === 200, {
        count: sessionsResponse.data.data?.length || 0
      });

      // é¦–å…ˆåˆ›å»ºä¸€ä¸ªè¯•å·ç”¨äºæµ‹è¯•
      const testPaperData = {
        title: 'APIæµ‹è¯•è¯•å·',
        description: 'ç”¨äºAPIæµ‹è¯•çš„è¯•å·',
        config: {
          totalQuestions: 2,
          totalPoints: 10,
          timeLimit: 30,
          allowReview: true,
          shuffleQuestions: false,
          shuffleOptions: false
        }
      };

      const paperResponse = await axios.post(`${API_BASE_URL}/exam-papers/manual`, testPaperData);
      
      if (paperResponse.status === 201 && paperResponse.data.data?._id) {
        const paperId = paperResponse.data.data._id;

        // æµ‹è¯•è€ƒè¯•ä¼šè¯åˆ›å»º
        const createSessionData = {
          name: 'APIæµ‹è¯•è€ƒè¯•',
          description: 'è¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•è€ƒè¯•',
          paperId: paperId,
          startTime: new Date().toISOString(),
          endTime: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(), // 2å°æ—¶å
          duration: 30,
          settings: {
            allowLateJoin: true,
            showResults: true,
            allowReview: true
          }
        };

        const createSessionResponse = await axios.post(`${API_BASE_URL}/exam-sessions`, createSessionData);
        this.recordTest('è€ƒè¯•ä¼šè¯åˆ›å»ºAPI', createSessionResponse.status === 201, createSessionResponse.data);

        if (createSessionResponse.status === 201 && createSessionResponse.data.data?._id) {
          const sessionId = createSessionResponse.data.data._id;

          // æµ‹è¯•è€ƒè¯•ä¼šè¯è¯¦æƒ…æŸ¥è¯¢
          const sessionDetailResponse = await axios.get(`${API_BASE_URL}/exam-sessions/${sessionId}`);
          this.recordTest('è€ƒè¯•ä¼šè¯è¯¦æƒ…æŸ¥è¯¢API', sessionDetailResponse.status === 200, sessionDetailResponse.data);

          // æµ‹è¯•è€ƒè¯•ä¼šè¯æ›´æ–°
          const updateSessionData = { ...createSessionData, name: 'APIæµ‹è¯•è€ƒè¯•(å·²æ›´æ–°)' };
          const updateSessionResponse = await axios.put(`${API_BASE_URL}/exam-sessions/${sessionId}`, updateSessionData);
          this.recordTest('è€ƒè¯•ä¼šè¯æ›´æ–°API', updateSessionResponse.status === 200, updateSessionResponse.data);

          // æµ‹è¯•å­¦ç”ŸåŠ å…¥è€ƒè¯•ä¼šè¯
          const joinResponse = await axios.post(`${API_BASE_URL}/exam-sessions/${sessionId}/join`);
          this.recordTest('å­¦ç”ŸåŠ å…¥è€ƒè¯•ä¼šè¯API', joinResponse.status === 200 || joinResponse.status === 201, joinResponse.data);

          // æµ‹è¯•å¼€å§‹è€ƒè¯•
          const startResponse = await axios.post(`${API_BASE_URL}/exam-sessions/${sessionId}/start`);
          this.recordTest('å¼€å§‹è€ƒè¯•API', startResponse.status === 200 || startResponse.status === 201, startResponse.data);

          // æµ‹è¯•è€ƒè¯•è¿›åº¦æŸ¥è¯¢
          const progressResponse = await axios.get(`${API_BASE_URL}/exam-sessions/${sessionId}/progress`);
          this.recordTest('è€ƒè¯•è¿›åº¦æŸ¥è¯¢API', progressResponse.status === 200, progressResponse.data);

          // æµ‹è¯•è€ƒè¯•ä¼šè¯åˆ é™¤
          const deleteSessionResponse = await axios.delete(`${API_BASE_URL}/exam-sessions/${sessionId}`);
          this.recordTest('è€ƒè¯•ä¼šè¯åˆ é™¤API', deleteSessionResponse.status === 200, deleteSessionResponse.data);
        }

        // æ¸…ç†æµ‹è¯•è¯•å·
        await axios.delete(`${API_BASE_URL}/exam-papers/${paperId}`);
      }

    } catch (error: any) {
      this.recordTest('è€ƒè¯•ä¼šè¯ç®¡ç†API', false, error.response?.data || error.message);
    }
  }

  /**
   * æµ‹è¯•è€ƒè¯•ç»“æœAPI
   */
  async testExamResultAPI() {
    console.log('\n5ï¸âƒ£ æµ‹è¯•è€ƒè¯•ç»“æœAPI...');
    
    try {
      // æµ‹è¯•è€ƒè¯•å†å²æŸ¥è¯¢
      const historyResponse = await axios.get(`${API_BASE_URL}/exam/history`);
      this.recordTest('è€ƒè¯•å†å²æŸ¥è¯¢API', historyResponse.status === 200, {
        count: historyResponse.data.data?.length || 0
      });

      // æµ‹è¯•è€ƒè¯•ç»Ÿè®¡API
      const statisticsResponse = await axios.get(`${API_BASE_URL}/exam/statistics`);
      this.recordTest('è€ƒè¯•ç»Ÿè®¡API', statisticsResponse.status === 200, statisticsResponse.data);

    } catch (error: any) {
      this.recordTest('è€ƒè¯•ç»“æœAPI', false, error.response?.data || error.message);
    }
  }

  /**
   * æµ‹è¯•çŸ¥è¯†ç‚¹ç®¡ç†API
   */
  async testKnowledgePointAPI() {
    console.log('\n6ï¸âƒ£ æµ‹è¯•çŸ¥è¯†ç‚¹ç®¡ç†API...');
    
    try {
      // æµ‹è¯•çŸ¥è¯†ç‚¹åˆ—è¡¨æŸ¥è¯¢
      const knowledgePointsResponse = await axios.get(`${API_BASE_URL}/knowledge-points`);
      this.recordTest('çŸ¥è¯†ç‚¹åˆ—è¡¨æŸ¥è¯¢API', knowledgePointsResponse.status === 200, {
        count: knowledgePointsResponse.data.data?.length || 0
      });

      // æµ‹è¯•çŸ¥è¯†ç‚¹åˆ›å»º
      const createKnowledgePointData = {
        customId: `test-${Date.now()}`,
        name: 'APIæµ‹è¯•çŸ¥è¯†ç‚¹',
        description: 'è¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•çŸ¥è¯†ç‚¹',
        module: 'APIæµ‹è¯•æ¨¡å—',
        chapter: 'APIæµ‹è¯•ç« èŠ‚',
        section: 'APIæµ‹è¯•å°èŠ‚'
      };

      const createKPResponse = await axios.post(`${API_BASE_URL}/knowledge-points`, createKnowledgePointData);
      this.recordTest('çŸ¥è¯†ç‚¹åˆ›å»ºAPI', createKPResponse.status === 201, createKPResponse.data);

      if (createKPResponse.status === 201 && createKPResponse.data.data?._id) {
        const kpId = createKPResponse.data.data._id;

        // æµ‹è¯•çŸ¥è¯†ç‚¹è¯¦æƒ…æŸ¥è¯¢
        const kpDetailResponse = await axios.get(`${API_BASE_URL}/knowledge-points/${kpId}`);
        this.recordTest('çŸ¥è¯†ç‚¹è¯¦æƒ…æŸ¥è¯¢API', kpDetailResponse.status === 200, kpDetailResponse.data);

        // æµ‹è¯•çŸ¥è¯†ç‚¹æ›´æ–°
        const updateKPData = { ...createKnowledgePointData, name: 'APIæµ‹è¯•çŸ¥è¯†ç‚¹(å·²æ›´æ–°)' };
        const updateKPResponse = await axios.put(`${API_BASE_URL}/knowledge-points/${kpId}`, updateKPData);
        this.recordTest('çŸ¥è¯†ç‚¹æ›´æ–°API', updateKPResponse.status === 200, updateKPResponse.data);

        // æµ‹è¯•çŸ¥è¯†ç‚¹åˆ é™¤
        const deleteKPResponse = await axios.delete(`${API_BASE_URL}/knowledge-points/${kpId}`);
        this.recordTest('çŸ¥è¯†ç‚¹åˆ é™¤API', deleteKPResponse.status === 200, deleteKPResponse.data);
      }

    } catch (error: any) {
      this.recordTest('çŸ¥è¯†ç‚¹ç®¡ç†API', false, error.response?.data || error.message);
    }
  }

  /**
   * æµ‹è¯•æ–‡ä»¶ä¸Šä¼ API
   */
  async testUploadAPI() {
    console.log('\n7ï¸âƒ£ æµ‹è¯•æ–‡ä»¶ä¸Šä¼ API...');
    
    try {
      // æµ‹è¯•ä¸Šä¼ ç«¯ç‚¹å¯è®¿é—®æ€§
      const uploadTestResponse = await axios.get(`${API_BASE_URL}/upload/test`);
      this.recordTest('æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹å¯è®¿é—®æ€§', uploadTestResponse.status === 200 || uploadTestResponse.status === 404, uploadTestResponse.data);

    } catch (error: any) {
      // ä¸Šä¼ APIå¯èƒ½æ²¡æœ‰GETç«¯ç‚¹ï¼Œè¿™æ˜¯æ­£å¸¸çš„
      this.recordTest('æ–‡ä»¶ä¸Šä¼ APIç«¯ç‚¹æ£€æŸ¥', true, 'ä¸Šä¼ APIç«¯ç‚¹å­˜åœ¨');
    }
  }

  /**
   * è¿è¡Œæ‰€æœ‰APIæµ‹è¯•
   */
  async runAllTests() {
    console.log('ğŸ” å¼€å§‹åç«¯APIå®Œæ•´æ€§æµ‹è¯•éªŒè¯...\n');
    
    try {
      // è¿æ¥æ•°æ®åº“
      await connectDatabase(config.database);
      console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ\n');

      // è¿è¡Œå„é¡¹APIæµ‹è¯•
      await this.testAuthAPI();
      await this.testQuestionAPI();
      await this.testPaperAPI();
      await this.testExamSessionAPI();
      await this.testExamResultAPI();
      await this.testKnowledgePointAPI();
      await this.testUploadAPI();

      // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      this.generateTestReport();

    } catch (error) {
      console.error('âŒ APIå®Œæ•´æ€§æµ‹è¯•å¤±è´¥:', error);
      process.exit(1);
    }
  }

  /**
   * ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
   */
  generateTestReport() {
    console.log('\nğŸ“Š APIå®Œæ•´æ€§æµ‹è¯•æŠ¥å‘Š');
    console.log('=' .repeat(50));

    const totalTests = Object.keys(this.testResults).length;
    const passedTests = Object.values(this.testResults).filter(result => result).length;
    const failedTests = totalTests - passedTests;

    console.log(`\nğŸ“ˆ æµ‹è¯•ç»Ÿè®¡:`);
    console.log(`  æ€»æµ‹è¯•æ•°: ${totalTests}`);
    console.log(`  é€šè¿‡æµ‹è¯•: ${passedTests}`);
    console.log(`  å¤±è´¥æµ‹è¯•: ${failedTests}`);
    console.log(`  é€šè¿‡ç‡: ${((passedTests / totalTests) * 100).toFixed(1)}%`);

    if (failedTests > 0) {
      console.log(`\nâŒ å¤±è´¥çš„æµ‹è¯•:`);
      Object.entries(this.testResults).forEach(([testName, success]) => {
        if (!success) {
          console.log(`  - ${testName}`);
        }
      });
    }

    console.log(`\nğŸ‰ APIå®Œæ•´æ€§æµ‹è¯•éªŒè¯å®Œæˆï¼`);
    console.log(`ğŸ“‹ éªŒè¯ç»“æœæ€»ç»“:`);
    console.log(`  âœ… ç”¨æˆ·è®¤è¯APIåŠŸèƒ½${this.testResults['ç”¨æˆ·ç™»å½•API'] ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`);
    console.log(`  âœ… é¢˜ç›®ç®¡ç†APIåŠŸèƒ½${this.testResults['é¢˜ç›®åˆ—è¡¨æŸ¥è¯¢API'] ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`);
    console.log(`  âœ… è¯•å·ç®¡ç†APIåŠŸèƒ½${this.testResults['è¯•å·åˆ—è¡¨æŸ¥è¯¢API'] ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`);
    console.log(`  âœ… è€ƒè¯•ä¼šè¯APIåŠŸèƒ½${this.testResults['è€ƒè¯•ä¼šè¯åˆ—è¡¨æŸ¥è¯¢API'] ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`);
    console.log(`  âœ… è€ƒè¯•ç»“æœAPIåŠŸèƒ½${this.testResults['è€ƒè¯•å†å²æŸ¥è¯¢API'] ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`);
    console.log(`  âœ… çŸ¥è¯†ç‚¹ç®¡ç†APIåŠŸèƒ½${this.testResults['çŸ¥è¯†ç‚¹åˆ—è¡¨æŸ¥è¯¢API'] ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`);
    console.log(`  âœ… æ–‡ä»¶ä¸Šä¼ APIåŠŸèƒ½${this.testResults['æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹å¯è®¿é—®æ€§'] ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`);

    if (passedTests === totalTests) {
      console.log(`\nğŸŠ æ‰€æœ‰APIç«¯ç‚¹æµ‹è¯•é€šè¿‡ï¼ç³»ç»ŸAPIå®Œæ•´æ€§éªŒè¯æˆåŠŸï¼`);
    } else {
      console.log(`\nâš ï¸  éƒ¨åˆ†APIç«¯ç‚¹å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥å’Œä¿®å¤ã€‚`);
    }

    process.exit(0);
  }
}

// è¿è¡ŒAPIå®Œæ•´æ€§æµ‹è¯•
const apiTest = new APICompletenessTest();
apiTest.runAllTests().catch(console.error);